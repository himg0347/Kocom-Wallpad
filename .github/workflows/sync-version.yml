name: Auto Sync Version & Release

# const.pyê°€ ë³€ê²½ë˜ë©´ ì‹¤í–‰
on:
  push:
    paths:
      - 'custom_components/kocom_wallpad/const.py'
    branches:
      - main

permissions:
  contents: write

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      # 2. const.pyì—ì„œ ë²„ì „ ì¶”ì¶œ
      - name: ë²„ì „ ì¶”ì¶œ
        id: get_version
        run: |
          VERSION=$(grep -oP 'SW_VERSION\s*=\s*["\047]\K[^"\047]+' custom_components/kocom_wallpad/const.py)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ì°¾ì€ ë²„ì „: $VERSION"

      # 3. ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒœê·¸ì¸ì§€ í™•ì¸
      - name: ê¸°ì¡´ íƒœê·¸ í™•ì¸
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.get_version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ íƒœê·¸ v${{ steps.get_version.outputs.version }}ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… ìƒˆë¡œìš´ ë²„ì „ì…ë‹ˆë‹¤"
          fi

      # 4. manifest.json ì—…ë°ì´íŠ¸
      - name: manifest.json ì—…ë°ì´íŠ¸
        run: |
          python3 -c "
          import json
          
          with open('custom_components/kocom_wallpad/manifest.json', 'r') as f:
              manifest = json.load(f)
          
          manifest['version'] = '${{ steps.get_version.outputs.version }}'
          
          with open('custom_components/kocom_wallpad/manifest.json', 'w') as f:
              json.dump(manifest, f, indent=2)
          
          print('âœ… manifest.json ì—…ë°ì´íŠ¸ ì™„ë£Œ')
          "

      # 5. ë³€ê²½ì‚¬í•­ í™•ì¸
      - name: ë³€ê²½ì‚¬í•­ í™•ì¸
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      # 6. ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add custom_components/kocom_wallpad/manifest.json
          git commit -m "ğŸ”„ Auto-sync manifest.json version to ${{ steps.get_version.outputs.version }}"
          git push

      # 7. ë§ˆì§€ë§‰ ì»¤ë°‹ì—ì„œ ë³¸ë¬¸ ì¶”ì¶œ
      - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        if: steps.check_tag.outputs.exists == 'false'
        id: release_notes
        run: |
          # ë§ˆì§€ë§‰ ì»¤ë°‹ì˜ ì „ì²´ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
          FULL_MESSAGE=$(git log -1 --pretty=format:"%B" HEAD~1)
          
          # ì²« ë²ˆì§¸ ì¤„ (ì œëª©) ì œê±°í•˜ê³  ë³¸ë¬¸ë§Œ ì¶”ì¶œ
          EXTENDED_DESC=$(echo "$FULL_MESSAGE" | tail -n +2 | sed '/^$/d' | sed '/^[[:space:]]*$/d')
          
          if [ -n "$EXTENDED_DESC" ]; then
            # Extended descriptionì´ ìˆìœ¼ë©´ ì‚¬ìš© (ë³¸ë¬¸ë§Œ)
            RELEASE_BODY="- $EXTENDED_DESC"
          else
            # Extended descriptionì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€
            RELEASE_BODY="- ë²„ì „ ${{ steps.get_version.outputs.version }} ì—…ë°ì´íŠ¸"
          fi
          
          # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ íŒŒì¼ ìƒì„±
          echo "$RELEASE_BODY" > release_notes.md

      # 8. GitHub Release ìƒì„±
      - name: GitHub Release ìƒì„±
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: "v${{ steps.get_version.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'alpha') || contains(steps.get_version.outputs.version, 'rc') }}

      # 9. ì™„ë£Œ ì•Œë¦¼
      - name: ì™„ë£Œ ì•Œë¦¼
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          echo "ğŸ‰ ë¦´ë¦¬ì¦ˆ ìƒì„± ì™„ë£Œ!"
          echo "ğŸ“‹ ë²„ì „: ${{ steps.get_version.outputs.version }}"
          echo "ğŸ·ï¸ íƒœê·¸: ${{ steps.get_version.outputs.tag }}"
          echo "ğŸ”— ë§í¬: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag }}"